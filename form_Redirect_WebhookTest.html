<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <title></title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="https://cdn.elliemae.io/elliemae/core/ssf/1.0/elli.ssf.guest-with-polyfill.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script>
        var tpoAppObject = null;
        var appraisalCompany = "";
	var loanNumber = "";
	var loanProgramName = "";
	var highBalance = "";
        var loanGuid = "";
        var loFullName = "";
        var loPhoneNum = "";
        var loEmail = "";
        var loNMLS = "";
        var processorName = "";
        var processorPhoneNum = "";
        var processorEmail = "";
        var processorNMLS = "";
        var borrowerName = "";
        var CoBorrowerName = "";
        var transactionType = "";
        var programType = "";
        var otherProgramType = "";
        var occupancy = "";
        var fixedLoanTerm = "";
        var amortizationType = "";
        var armType = "";
        var propertyType = "";
        var compensation = "";
        var contactsList = [];
        var loanObj = {};
    // Instantiate objects on window load (one-time event handling).
    window.addEventListener("load", function () {
      elli.script.guest.create();
      elli.script.getObject("tpoApplication").then(function (tpoAppObject) {
        this.tpoAppObject = tpoAppObject;
        GetUserData();

		    // This call will only succeed on page load event if user already has opened a loan in TPOC.
		    // Use the onLoanOpened event (as shown below) to get/refresh loan data when user opens a loan.
          GetLoanData();
      });
    });
    // Subscribe to loanOpen event to refresh context when loan context changes (context event handling).
     elli.script.subscribe('tpoApplication', 'loanOpen', onLoanOpened);
     function onLoanOpened(proxy, loanData) {
       GetLoanData();
       this.loanData = loanData;
       console.log('loanOpen => loanData ===', loanData);
     }


    // Sample methods for getting various data objects, just console logging for illustrative purposes.
    function GetUserData() {
      // Get basic user info and console log only.
      tpoAppObject.getUserData().then(function (userData) {
        //console.log('User Data ===', userData);
      })
        .catch(function (err) {
          console.log('Fetch Error :-S', err);
        });
      // Get full user profile, console log and populate some basic on screen information.
      tpoAppObject.getUserProfileData().then(function (userProfileData) {
        //console.log('User Profile Data ===', userProfileData);
      })
        .catch(function (err) {
          console.log('Fetch Error :-S', err);
        });
        }


        function myFunction() {
          var loFullNameURL = "?tfa_2=" + loFullName + "&";
          var loanNumberURL = "tfa_339=" + loanNumber + "&";
          var loPhoneNumURL = "tfa_6=" + loPhoneNum + "&";
	var highBalanceURL = "tfa_324=" + highBalance + "&";
          var loEmailURL = "tfa_8=" + loEmail + "&";
          var processorNameURL = "tfa_303=" + processorName + "&";
          var processorEmailURL = "tfa_305=" + processorEmail + "&";
          var processorPhoneNumURL = "tfa_304=" + processorPhoneNum + "&";
          var borrowerNameURL = "tfa_18=" + borrowerName + "&";
          var programTypeURL = "tfa_283=" + programType + ";" + otherProgramType + "&";
          var propertyTypeURL = "tfa_243=" + propertyType + "&";
          var occupancyURL = "tfa_269=" + occupancy + "&";
          var fixedLoanTermURL = "tfa_265=" + fixedLoanTerm + "&";
          var amortizationTypeURL = "tfa_310=" + amortizationType + "&";
          var compensationURL = "tfa_249=" + compensation + "&";
          var loanGuidURL = "tfa_328=" + loanGuid + "&";
          var transactionTypeURL = "tfa_293=" + transactionType;
          //window.location.href('https://www.tfaforms.com/4759136?tfa_2=' + loFullName);
          var fieldValueString = loFullNameURL + loPhoneNumURL + loEmailURL + highBalanceURL + loanNumberURL + processorNameURL + processorEmailURL + processorPhoneNumURL + borrowerNameURL + programTypeURL + propertyTypeURL + occupancyURL + fixedLoanTermURL + amortizationTypeURL + compensationURL + loanGuidURL + transactionTypeURL;
          document.location.href = "https://www.tfaforms.com/4760677" + fieldValueString;
          //document.location.href = "https://www.tfaforms.com/4759136?/tfa_2=" + loFullName;
          //window.open('https://www.tfaforms.com/4759136?tfa_2=' + loFullName,'_blank');
          //window.open('https://www.actappraisal.com/#act-login', '_blank');
        }

    function GetLoanData() {
      // Get loan summary and console log only.
      // tpoAppObject.getLoanSummary().then(function (loanSummary) {
      //   console.log('Loan Summary ===', loanSummary);
      // })
      //   .catch(function (err) {
      //     console.log('Fetch Error :-S', err);
      //   });
      // Get full loan object, console log and populate some basic on screen information.
      tpoAppObject.getLoanData().then(function (loanData) {
          console.log('Loan Data ===', loanData);
          //Getting Appraisal Company Name
          contactsList = loanData.Contacts;
          loanGuid = loanData.EncompassId;
	  loanNumber = loanData.LoanNumber;
	  loanProgramName = loanData.LoanProgramName;
	  if(loanProgramName !== null) {
	     if(loanProgramName.includes('HB')) {
	        highBalance = 'High Balance';
	      }
	     else {
		highBalance = 'false';
	     } 
	  }
	      else { highBalance = 'false'; }
	      
          contactsList.forEach((item, index) => {
            if(item.ContactType === 'APPRAISAL_COMPANY')
            {
            console.log(item.Name);
            appraisalCompany = item.Name;
            }
            if(item.ContactType === 'LOAN_OFFICER')
            {
              if(item.Name != 'undefined')
              loFullName = item.Name;
              loPhoneNum = item.Phone;
              loEmail = item.Email;
            }
            if(item.ContactType === 'LOAN_PROCESSOR'){
              processorName = item.Name;
              processorPhoneNum = item.Phone;
              processorEmail = item.Email;
            }
          });

          //Setting loan officer name
          borrowerName = loanData.Applications[0].Borrower.FullName;
          transactionType = loanData.Property.LoanPurposeType;
          programType = loanData.MortgageType;
          propertyType = loanData.Uldd.AttachmentType;
          occupancy = loanData.Property.PropertyUsageType;
          amortizationType = loanData.LoanAmortizationType;
          compensation = loanData.RateLock.BorrLenderPaid;
          otherProgramType = loanData.LoanPurposeOfRefinanceType;


          if(loFullName == null) {
            loFullName = '';
            loEmail = '';
            loPhoneNum = '';
          }

          if(processorName == null){
            processorName = '';
            processorEmail = '';
            processorPhoneNum = '';
          }


          if(transactionType === 'NoCash-Out Refinance') { transactionType = 'Rate/Term Refinance'; }
          if(transactionType === 'Cash-Out Refinance') { transactionType = 'Cash-Out Refinance'; }

          if(programType === 'Conventional') {programType = 'Conforming';}
          if(programType === 'FarmersHomeAdministration') { programType = 'USDA'; }

          if(transactionType === 'Purchase') { programType = 'N/A'; }
          else {
            if(otherProgramType === 'InterestRateReductionRefinanceLoan') { otherProgramType = 'IRRRL'; }
            if(otherProgramType === 'FullDocumentation') { otherProgramType = 'Full Documentation'; }
            if(otherProgramType === 'StreamlineWithoutAppraisal') { otherProgramType = 'Streamline'; }
            if(otherProgramType === '') { otherProgramType = "N/A"; }
          }

          //programType = ( programType==='Conventional' ? 'Conforming' : programType);

          if(propertyType === 'Detached'){ propertyType = 'SFR';}
          if(propertyType === 'Condominium') { propertyType = 'Condo'; }

          if(occupancy === 'PrimaryResidence') { occupancy = 'Owner-Occupied';}
          if(occupancy === 'SecondHome') { occupancy = 'Second Home';}
          if(occupancy === 'Investor') { occupancy = 'Investment (NOO)';}

          if(amortizationType === 'Fixed') {
            amortizationType = 'Fixed Rate';
            fixedLoanTerm = loanData.LoanAmortizationTermMonths;
            fixedLoanTerm = fixedLoanTerm / 12;
            fixedLoanTerm = fixedLoanTerm + " YR";
          }
          else if(amortizationType === 'AdjustableRate') {
            amortizationType = 'ARM';
            //armType = loanData.;
          }

          //propertyType = ( propertyType==='Detached' ? 'SFR' : (propertyType ==='Condominium'? 'Condo' : propertyType) );
          console.log("LO Full Name: " + loFullName + " LO Phone Num: " + loPhoneNum + " LO Email: " + loEmail +
          " Processor Name: " + processorName + " Processor Email: " + processorEmail + " Processor Phone Num: " + processorPhoneNum +
          " BorrowerName: " + borrowerName + " CoborrowerName: " + CoBorrowerName + " TransactionType: " + transactionType +
          " ProgramType: " + programType + " OtherProgramType: " + otherProgramType + " PropertyType: " + propertyType +
          " Occupancy: " + occupancy + " Fixed loan Term: " + fixedLoanTerm + " AmortizationType: " + amortizationType +
          " Compensation: " + compensation);


          // if(loanData.Property.LoanPurposeType === "Cash-Out Refinance") { transactionType = "tfa_295"}
          // if(loanData.Property.LoanPurposeType === "Purchase") { transactionType = "tfa_294"}
          // if(loanData.Property.LoanPurposeType === "No Cash-Out Refinance") { transactionType = "tfa_296"}

          // loanData.Applications.forEach((item, index) => {
          //   borrowerName = item.Borrower.FullName;
          // });
            myFunction();
      })
        .catch(function (err) {
          console.log('Fetch Error :-S', err);
        });
    }
    </script>
</head>
<body style="font-family: ProximaNova-Medium,Helvetica,Arial,sans-serif;">
</body>
</html>
