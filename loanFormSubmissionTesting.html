<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <title></title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="https://cdn.elliemae.io/elliemae/core/ssf/1.0/elli.ssf.guest-with-polyfill.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script>	    
	var tpoAppObject = null;
  var siteId = "";
  var loanGuid = "";
  var loanNumber = "";
  var borrowerFirstName = "";
  var borrowerLastName = "";
	var user_FullName = "";
	var tpoLOEmail = "";
	var tpoProcEmail = "";
	var tpoPOCEmail = "";
  var accountExecutiveEmail = "";
  var loFullName = "";
  var loEmail = "";
  var processorName = "";
  var processorEmail = "";
	var borrowerType = "";
	var borrowerEmail = "";
  var contactsList = [];
  var customFields = [];
  
    // Instantiate objects on window load (one-time event handling).
    window.addEventListener("load", function () {
      elli.script.guest.create();
      elli.script.getObject("tpoApplication").then(function (tpoAppObject) {
        this.tpoAppObject = tpoAppObject;
		    // This call will only succeed on page load event if user already has opened a loan in TPOC.
		    // Use the onLoanOpened event (as shown below) to get/refresh loan data when user opens a loan.
          GetLoanData();
      });
    });
    
    // Subscribe to loanOpen event to refresh context when loan context changes (context event handling).
     elli.script.subscribe('tpoApplication', 'loanOpen', onLoanOpened);
     function onLoanOpened(proxy, loanData) {
       GetLoanData();
       this.loanData = loanData;
       console.log('loanOpen => loanData ===', loanData);
     }

    function GetLoanData() {
      tpoAppObject.getLoanData().then(function (loanData) {
          console.log('Loan Data ===', loanData);
          //Getting Appraisal Company Name
          contactsList = loanData.Contacts;
          console.log('Contacts list', contactsList);
          loanGuid = loanData.EncompassId;
	  loanNumber = loanData.LoanNumber;
    customFields = loanData.CustomFields;
	      if(customFields) {

    customFields.forEach((item, index) => {
	    if(item.FieldName === 'CX.AEEMAIL')
	    {
		    accountExecutiveEmail = item.StringValue;
	    }
    });
	      }
          contactsList.forEach((item, index) => {
            if(item.ContactType === 'LOAN_PROCESSOR'){
              processorName = item.Name;
              processorEmail = item.Email;
            }
	    if(item.CategoryName === 'Broker\'s Loan Contact'){
	      if(item.Email){
		 tpoPOCEmail = item.Email;
	      }
	      else { tpoPOCEmail = ""; }
	    }
          });
          borrowerFirstName = loanData.Applications[0].Borrower.FirstName;
	  borrowerLastName = loanData.Applications[0].Borrower.LastName;
	  borrowerEmail = loanData.Applications[0].Borrower.EmailAddressText;
	  if(!borrowerEmail)
	  {
		  borrowerEmail = '';
	  }
	      if(loanData.Applications[0].Coborrower.BorrowerType == 'Individual')
		 {
			 borrowerType = 'Individual';
		 }
	      tpoLOEmail = loanData.TPO.LOEmail;
	      tpoProcEmail = loanData.TPO.LPEmail;
	      }
          loFullName = loanData.TPO.LOName;
          loEmail = loanData.TPO.LOEmail;

          if(processorName == null){
            processorName = '';
            processorEmail = '';
          }
          console.log("LO Full Name: " + loFullName + " LO Email: " + loEmail +
          " Processor Name: " + processorName + " Processor Email: " + processorEmail + " Processor Phone Num: " +
          " BorrowerName: " + borrowerFirstName + 
          " user full name: " + user_FullName);
          
console.log(loanData);
  tpoAppObject.getExternalOrgDetails().then(function(externalOrgData) {
        console.log('External Org data ===', externalOrgData);
        siteId = externalOrgData.siteId;
        });    
      })
        .catch(function (err) {
          console.log('Fetch Error :-S', err);
        });
    }
    </script>
</head>
<body style="font-family: ProximaNova-Medium,Helvetica,Arial,sans-serif;">
</body>
</html>
